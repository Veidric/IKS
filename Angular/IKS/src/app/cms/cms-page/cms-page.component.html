<div class="cms-container">
  <h1>User Management</h1>

  <div class="alphabet-filter">
    <button class="letter-btn" [class.active]="selectedLetter === ''" (click)="filterByLetter('')">
      ALL
    </button>
    @for(letter of alphabet; track letter) {
    <button
      class="letter-btn"
      [class.active]="selectedLetter === letter"
      (click)="filterByLetter(letter)"
    >
      {{ letter }}
    </button>
    }
  </div>

  <div class="controls-row">
    <div class="search-container">
      <input
        type="text"
        placeholder="Search users..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="currentPage = 1"
      />
    </div>
    <div class="page-size-selector">
      <label>Show:</label>
      <select [(ngModel)]="itemsPerPage" (change)="currentPage = 1">
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
      </select>
    </div>
  </div>

  @if (users | filterUser:searchTerm:selectedLetter | sortUser:sortColumn:sortDirection; as processedUsers) {

  <table class="cms-table">
    <thead>
      <tr>
        <th (click)="sort('id')" class="sortable">
          ID
          <span class="sort-icon">{{ sortColumn === 'id' ? (sortDirection === 'asc' ? '▲' : '▼') : '' }}</span>
        </th>
        <th (click)="sort('name')" class="sortable">
          Full Name
          <span class="sort-icon">{{ sortColumn === 'name' ? (sortDirection === 'asc' ? '▲' : '▼') : '' }}</span>
        </th>
        <th (click)="sort('username')" class="sortable">
          Username
          <span class="sort-icon">{{ sortColumn === 'username' ? (sortDirection === 'asc' ? '▲' : '▼') : '' }}</span>
        </th>
        <th (click)="sort('isAdmin')" class="sortable">
          Role
          <span class="sort-icon">{{ sortColumn === 'isAdmin' ? (sortDirection === 'asc' ? '▲' : '▼') : '' }}</span>
        </th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      @for(user of processedUsers | paginateUser:currentPage:itemsPerPage; track user.id) {
      <tr>
        <td>{{ user.id }}</td>
        <td>{{ user.name }} {{ user.surname }}</td>
        <td>{{ user.username }}</td>
        <td>
          <span [class.admin-badge]="user.isAdmin === 1">
            {{ user.isAdmin === 1 ? 'ADMIN' : 'USER' }}
          </span>
        </td>
        <td>
          <button class="btn-edit" (click)="openEditModal(user)">Edit</button>
          <button class="btn-delete" (click)="deleteUser(user.id)">Delete</button>
        </td>
      </tr>
      } @if(processedUsers.length === 0 && !isLoading) {
      <tr>
        <td colspan="5" class="empty-message">No users found.</td>
      </tr>
      }
    </tbody>
  </table>

  @if(processedUsers.length > itemsPerPage) {
  <div class="pagination-footer">
    <button (click)="prevPage()" [disabled]="currentPage === 1">Previous</button>

    <span class="page-info">
      Page {{ currentPage }} of {{ processedUsers.length / itemsPerPage | number : '1.0-0' }}
    </span>

    <button
      (click)="nextPage(processedUsers.length)"
      [disabled]="currentPage * itemsPerPage >= processedUsers.length"
    >
      Next
    </button>
  </div>
  } }
</div>

@if(isModalOpen) {
<div class="modal-overlay">
  <div class="modal form formModal">
    
    <h2>Edit User</h2>

    <div class="profile-image-section">
      <div class="image-container">
        <img [src]="profileImageSafeUrl" alt="Loading..." class="profile-preview" *ngIf="profileImageSafeUrl">
        <div class="no-image" *ngIf="!profileImageSafeUrl">No Image</div>
      </div>
      
      <div class="image-actions">
        <button type="button" class="btn-remove-img" (click)="deleteProfileImage()">
          Remove Image
        </button>
        <p class="image-hint">Removes custom photo and reverts to default.</p>
      </div>
    </div>

    <form (ngSubmit)="saveUser()"> <div>
        <div class="label">
          <label for="username">Username</label>
        </div>
        <div class="inputWrapper">
          <input id="username" name="username" [(ngModel)]="editForm.username" placeholder="Username" />
        </div>
      </div>

      <div>
        <div class="label">
          <label for="name">Name</label>
        </div>
        <div class="inputWrapper">
          <input id="name" name="name" [(ngModel)]="editForm.name" placeholder="Name" />
        </div>
      </div>

      <div>
        <div class="label">
          <label for="surname">Surname</label>
        </div>
        <div class="inputWrapper">
          <input id="surname" name="surname" [(ngModel)]="editForm.surname" placeholder="Surname" />
        </div>
      </div>

      <div>
        <div class="label">
          <label for="dateOfBirth">Date of Birth</label>
        </div>
        <div class="inputWrapper">
          <input type="date" id="dateOfBirth" name="dateOfBirth" [(ngModel)]="editForm.dateOfBirth" />
        </div>
      </div>

      <div>
        <div class="label">
          <label for="role">Role</label>
        </div>
        <div class="inputWrapper">
          <select id="role" name="role" [(ngModel)]="editForm.isAdmin">
            <option [ngValue]="0">User</option>
            <option [ngValue]="1">Admin</option>
          </select>
        </div>
      </div>

      <div class="flexHorizontal" style="margin-top: 1em;">
        <button type="button" class="grayButton" (click)="closeModal()">Cancel</button>
        <button type="submit" class="greenButton submitButton">Save Changes</button>
      </div>

    </form>
  </div>
</div>
}